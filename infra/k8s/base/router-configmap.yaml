apiVersion: v1
kind: ConfigMap
metadata:
  name: apollo-router-config
  namespace: platform
  labels:
    app: platform-gateway
  annotations:
    config.kubernetes.io/source: infra/gateway/apollo-router-config.yaml
data:
  router.yaml: |
    supergraph:
      path: /config/supergraph.graphql
    health-check:
      listen: 0.0.0.0:8088
    telemetry:
      exporters:
        tracing:
          otlp:
            endpoint: http://otel-collector.observability:4317
            protocol: grpc
        metrics:
          prometheus:
            listen: 0.0.0.0:9090
      sampling:
        probability: 0.1
    cors:
      allow_origins:
        - https://app.tribalmingle.com
        - https://admin.tribalmingle.com
    headers:
      all:
        request:
          - propagate:
              named: x-request-id
          - insert:
              name: x-router-region
              value: "{{ $env.RAW_REGION | default \"us-east-1\" }}"
    plugins:
      authentication:
        jwt:
          jwks:
            - url: https://auth.tribalmingle.com/.well-known/jwks.json
          audience:
            - member-app
            - admin-app
      rate-limit:
        global:
          capacity: 2000
          interval: 1s
